---
import type { LeagueStanding } from '../types';
import { usernameToSlug } from '../utils/helpers';
import Tooltip from './Tooltip.astro';

interface Props {
  standings: LeagueStanding[] | null;
}

const { standings } = Astro.props;
---

<style>
  .leaderboard-header {
    background: var(--gradient-primary);
    color: white;
    padding: 1.5rem 2rem;
    display: grid;
    grid-template-columns: 60px 1fr 80px 100px 180px 180px 100px;
    gap: 1rem;
    font-weight: 600;
    font-size: 0.9rem;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
  }

  .leaderboard-header > div {
    text-align: left;
  }

  .leaderboard-row {
    padding: 1.5rem 2rem;
    display: grid;
    grid-template-columns: 60px 1fr 80px 100px 180px 180px 100px;
    gap: 1rem;
    align-items: center;
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s ease;
  }

  .leaderboard-row:hover {
    background-color: #f5f5f5;
  }

  .leaderboard-row:last-child {
    border-bottom: none;
  }

  .leaderboard-row.hidden {
    display: none;
  }

  .view-more-container {
    padding: 1.5rem 2rem;
    text-align: center;
    border-top: 1px solid #e0e0e0;
  }

  .view-more-counter {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .view-more-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .view-more-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
  }

  .view-more-btn:active {
    transform: translateY(0);
  }

  .view-more-container.hidden {
    display: none;
  }

  .rank {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
    text-align: left;
  }

  .rank-1 {
    color: #ffd700;
    font-size: 2rem;
  }
  .rank-2 {
    color: #c0c0c0;
    font-size: 1.8rem;
  }
  .rank-3 {
    color: #cd7f32;
    font-size: 1.6rem;
  }

  .player-link {
    text-decoration: none;
    display: block;
  }

  .player-link:hover .player-name {
    color: #764ba2;
  }

  .player-link:hover .player-username {
    text-decoration: underline;
  }

  .player-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    transition: color 0.2s ease;
  }

  .player-username {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }

  .stat {
    text-align: left;
    font-weight: 500;
  }

  .stat-value {
    font-size: 1.1rem;
    color: #333;
  }

  .stat-zero {
    opacity: 0.3;
  }

  .trophy-pills {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-start;
    align-items: center;
  }

  .trophy-pill,
  .belt-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }

  .trophy-pill {
    background: rgba(255, 215, 0, 0.15);
    color: #b8860b;
  }

  .belt-pill {
    background: rgba(138, 43, 226, 0.15);
    color: #6a2199;
  }

  .stat-label {
    font-size: 0.75rem;
    color: #999;
    text-transform: uppercase;
    margin-top: 0.25rem;
  }

  .points {
    font-size: 1.3rem;
    font-weight: 700;
    color: #667eea;
  }

  .record {
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    color: #555;
  }

  .percent-label {
    font-size: 0.85rem;
    color: #888;
    margin-top: 0.25rem;
    font-weight: 500;
  }

  .wp-high {
    color: #10b981;
  }
  .wp-medium {
    color: #f59e0b;
  }
  .wp-low {
    color: #ef4444;
  }

  .no-data {
    text-align: center;
    padding: 4rem 2rem;
    color: #666;
  }

  .no-data h2 {
    color: #333;
    margin-bottom: 1rem;
  }

  .no-data p {
    color: #666;
    font-size: 1.1rem;
  }

  .no-data code {
    background: #f0f0f0;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
  }

  @media (max-width: 1024px) {
    .leaderboard-header,
    .leaderboard-row {
      grid-template-columns: 50px 1fr 60px 80px 140px 140px;
      gap: 0.5rem;
      padding: 1rem;
    }

    /* Hide Trophies column on medium screens */
    .stat:nth-child(7) {
      display: none;
    }

    /* Hide Trophies header on medium screens */
    .leaderboard-header > div:nth-child(7) {
      display: none;
    }
  }

  @media (max-width: 640px) {
    .leaderboard-header,
    .leaderboard-row {
      grid-template-columns: 35px 1fr 55px 90px 90px;
      padding: 1rem 0.75rem;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .leaderboard-header {
      font-size: 0.7rem;
      line-height: 1.2;
    }

    .leaderboard-header > div {
      white-space: normal;
      word-break: break-word;
    }

    /* Hide Events and Trophies columns on mobile */
    .stat:nth-child(3),
    .stat:nth-child(7) {
      display: none;
    }

    /* Hide Events and Trophies headers on mobile */
    .leaderboard-header > div:nth-child(3),
    .leaderboard-header > div:nth-child(7) {
      display: none;
    }

    .rank {
      font-size: 1.2rem;
    }

    .rank-1 {
      font-size: 1.4rem;
    }
    .rank-2 {
      font-size: 1.3rem;
    }
    .rank-3 {
      font-size: 1.25rem;
    }

    .player-name {
      font-size: 0.95rem;
    }

    .player-username {
      font-size: 0.7rem;
    }

    .record {
      font-size: 0.8rem;
    }

    .percent-label {
      font-size: 0.65rem;
    }
  }
</style>

<div class="card">
  {
    standings ? (
      <Fragment>
        <div class="leaderboard-header">
          <div>Rank</div>
          <div>Player</div>
          <div>Events</div>
          <div>Points</div>
          <div>Matches</div>
          <div>Games</div>
          <div>
            <Tooltip content="3-0 finishes">Trophies</Tooltip>
          </div>
        </div>

        {standings.map((standing, index) => {
          const player = standing.Team.Players[0];
          const isTopThree = standing.Rank < 4;
          const rankClass = isTopThree ? `rank-${standing.Rank}` : '';
          const isHidden = index >= 16;

          // Calculate match win percentage with color treatment
          const totalMatches = standing.MatchWins + standing.MatchLosses + standing.MatchDraws;
          const mwPercent =
            totalMatches > 0 ? ((standing.MatchWins / totalMatches) * 100).toFixed(1) : '0.0';
          const mwPercentNum = totalMatches > 0 ? standing.MatchWins / totalMatches : 0;
          const isHighMWP = mwPercentNum > 0.59;
          const isMediumMWP = mwPercentNum > 0.39;
          const mwClass = isHighMWP ? 'wp-high' : isMediumMWP ? 'wp-medium' : 'wp-low';

          // Calculate game win percentage with color treatment
          const gwPercent = (standing.TeamGameWinPercentage * 100).toFixed(1);
          const isHighGWP = standing.TeamGameWinPercentage > 0.59;
          const isMediumGWP = standing.TeamGameWinPercentage > 0.39;
          const gwClass = isHighGWP ? 'wp-high' : isMediumGWP ? 'wp-medium' : 'wp-low';

          const playerSlug = usernameToSlug(player.Username);
          const playerUrl = `/player/${playerSlug}`;

          return (
            <div class={`leaderboard-row ${isHidden ? 'hidden' : ''}`} onclick={`window.location.href='${playerUrl}'`} style="cursor: pointer;">
              <div class={`rank ${rankClass}`}>{standing.Rank}</div>
              <div>
                <div class="player-name">{player.DisplayName}</div>
                <div class="player-username">@{player.Username}</div>
              </div>
              <div class="stat">
                <div class="stat-value">{standing.TournamentCount || 0}</div>
              </div>
              <div class="stat">
                <div class="points">{standing.Points}</div>
              </div>
              <div class="stat">
                <div class="record">{standing.MatchRecord}</div>
                <div class={`percent-label ${mwClass}`}>({mwPercent}%)</div>
              </div>
              <div class="stat">
                <div class="record">{standing.GameRecord}</div>
                <div class={`percent-label ${gwClass}`}>({gwPercent}%)</div>
              </div>
              <div class="stat">
                <div class={`stat-value trophy-pills ${(standing.Trophies || 0) === 0 && (standing.Belts || 0) === 0 ? 'stat-zero' : ''}`}>
                  {
                    (standing.Trophies || 0) === 0 && (standing.Belts || 0) === 0 ? (
                      '-'
                    ) : (
                      <>
                        {(standing.Trophies || 0) > 0 && (
                          <span class="trophy-pill">üèÜ {standing.Trophies}</span>
                        )}
                        {(standing.Belts || 0) > 0 && (
                          <span class="belt-pill">üëë {standing.Belts}</span>
                        )}
                      </>
                    )
                  }
                </div>
              </div>
            </div>
          );
        })}

        {standings.length > 16 && (
          <div class="view-more-container" id="view-more-container">
            <div class="view-more-counter" id="view-more-counter">
              Showing 16 of {standings.length}
            </div>
            <button class="view-more-btn" id="view-more-btn">
              View More
            </button>
          </div>
        )}
      </Fragment>
    ) : (
      <div class="no-data">
        <h2>No League Data Available</h2>
        <p>Run the league aggregator to generate standings:</p>
        <p>
          <code>npm run league 384681 382756</code>
        </p>
      </div>
    )
  }
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const viewMoreBtn = document.getElementById('view-more-btn');
    const viewMoreContainer = document.getElementById('view-more-container');

    if (viewMoreBtn && viewMoreContainer) {
      viewMoreBtn.addEventListener('click', () => {
        // Get all currently hidden rows and show them all
        const hiddenRows = document.querySelectorAll('.leaderboard-row.hidden');
        hiddenRows.forEach((row) => {
          row.classList.remove('hidden');
        });

        // Hide the View More container
        viewMoreContainer.classList.add('hidden');
      });
    }
  });
</script>
