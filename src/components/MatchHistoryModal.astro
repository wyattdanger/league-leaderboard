---
import type { HeadToHeadMatchDetail } from '../types';
import type { PlayerDetailData } from '../types';
import Modal from './Modal.astro';
import * as fs from 'fs';
import * as path from 'path';

interface Props {
  matches: HeadToHeadMatchDetail[];
  opponentDisplayName: string;
  playerUsername: string;
}

const { matches, opponentDisplayName, playerUsername } = Astro.props;

// Load player data to get display name
const playersDir = path.join(process.cwd(), 'output', 'players');
const playerFile = path.join(playersDir, `player_stats_${playerUsername.toLowerCase()}.json`);
const playerData: PlayerDetailData = JSON.parse(fs.readFileSync(playerFile, 'utf-8'));
const playerDisplayName = playerData.displayName;

// Sort matches by date (newest first)
const sortedMatches = [...matches].sort((a, b) => {
  const aId = parseInt(a.tournamentId);
  const bId = parseInt(b.tournamentId);
  return bId - aId;
});

const modalId = `modal-${opponentDisplayName.replace(/\s+/g, '-')}`;
---

<Modal id={modalId}>
  <h2 slot="header">Match History vs {opponentDisplayName}</h2>
  <table class="match-history-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>{playerDisplayName}</th>
        <th>{opponentDisplayName}</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
      {sortedMatches.map((match) => {
        const resultClass = match.result === 'W' ? 'result-win' : match.result === 'L' ? 'result-loss' : 'result-draw';
        const playerDeckDisplay = (match.playerDeck && match.playerDeck !== '_') ? match.playerDeck : 'Unknown';
        const opponentDeckDisplay = (match.opponentDeck && match.opponentDeck !== '_') ? match.opponentDeck : 'Unknown';

        return (
          <tr class={resultClass}>
            <td class="match-date">
              <a href={`/event/${match.tournamentId}`} target="_blank">
                {match.dateDisplay}
              </a>
            </td>
            <td class="deck-name">{playerDeckDisplay}</td>
            <td class="deck-name">{opponentDeckDisplay}</td>
            <td class="match-score">
              {match.playerGameWins}-{match.opponentGameWins}
              {match.gameDraws > 0 && `-${match.gameDraws}`}
            </td>
          </tr>
        );
      })}
    </tbody>
  </table>
</Modal>

<style>
  .match-history-table {
    width: 100%;
    border-collapse: collapse;
  }

  .match-history-table thead {
    background: #f9fafb;
    color: #764ba2;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .match-history-table th {
    padding: 1rem;
    font-weight: 600;
    font-size: 0.85rem;
    text-align: left;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }

  .match-history-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .match-history-table tbody tr {
    transition: background-color 0.2s;
  }

  .match-history-table tbody tr:hover {
    opacity: 0.8;
  }

  .match-history-table tbody tr.result-win {
    background-color: rgba(16, 185, 129, 0.08);
  }

  .match-history-table tbody tr.result-loss {
    background-color: rgba(239, 68, 68, 0.08);
  }

  .match-history-table tbody tr.result-draw {
    background-color: rgba(107, 114, 128, 0.08);
  }

  .match-date a {
    color: #667eea;
    font-weight: 600;
    text-decoration: none;
  }

  .match-date a:hover {
    text-decoration: underline;
  }

  .deck-name {
    font-weight: 500;
    color: #374151;
  }

  .match-score {
    font-family: monospace;
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
  }

  @media (max-width: 768px) {
    .match-history-table th,
    .match-history-table td {
      padding: 0.75rem 0.5rem;
      font-size: 0.85rem;
    }

    .deck-name {
      font-size: 0.8rem;
    }
  }
</style>
