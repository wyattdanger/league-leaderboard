---
import PageLayout from '../../components/PageLayout.astro';
import LeagueHeader from '../../components/LeagueHeader.astro';
import Tooltip from '../../components/Tooltip.astro';
import { getTournamentMetadata } from '../../utils/tournamentData';
import * as fs from 'fs';
import * as path from 'path';

export async function getStaticPaths() {
  const outputDir = path.join(process.cwd(), 'output');
  const tournamentDirs = fs.readdirSync(outputDir).filter((dir) =>
    dir.startsWith('tournament_')
  );

  return tournamentDirs.map((dir) => {
    const tournamentId = parseInt(dir.replace('tournament_', ''));
    return {
      params: { tournamentId: tournamentId.toString() },
      props: { tournamentId },
    };
  });
}

const { tournamentId } = Astro.props;
const metadata = getTournamentMetadata(tournamentId);

if (!metadata) {
  return Astro.redirect('/league/overall');
}

// Load final standings
const tournamentDir = path.join(process.cwd(), 'output', `tournament_${tournamentId}`);
const finalStandingsPath = path.join(tournamentDir, `Round_${metadata.roundCount}_Standings.json`);
const standings = JSON.parse(fs.readFileSync(finalStandingsPath, 'utf-8'));

// Load match data for each round
const rounds = [];
for (let i = 1; i <= metadata.roundCount; i++) {
  const matchesPath = path.join(tournamentDir, `Round_${i}_Matches.json`);
  if (fs.existsSync(matchesPath)) {
    const matches = JSON.parse(fs.readFileSync(matchesPath, 'utf-8'));
    rounds.push({ roundNumber: i, matches });
  }
}
---

<PageLayout>
  <LeagueHeader />

  <div class="card">
    <div class="event-profile-header">
      <div class="event-name-group">
        <h1>{metadata.dateDisplay}</h1>
      </div>
      <div class="event-metadata">
        <Tooltip content={`${metadata.playerCount} ${metadata.playerCount === 1 ? 'player' : 'players'} attended`}>
          <div class="metadata-badge">
            üë§ {metadata.playerCount}
          </div>
        </Tooltip>
        <Tooltip content={`${metadata.trophyCount} ${metadata.trophyCount === 1 ? 'player' : 'players'} went 3-0`}>
          <div class="metadata-badge">
            üèÜ {metadata.trophyCount}
          </div>
        </Tooltip>
        <Tooltip content={`${metadata.roundCount} ${metadata.roundCount === 1 ? 'round' : 'rounds'} of Swiss`}>
          <div class="metadata-badge">
            ‚öîÔ∏è {metadata.roundCount}
          </div>
        </Tooltip>
      </div>
    </div>

    <div class="event-content">
      <div class="standings-section">
        <div class="standings-table">
          <table>
            <thead>
              <tr>
                <th class="rank-col">Rank</th>
                <th class="player-col">Player</th>
                <th class="record-col">Record</th>
                <th class="mwp-col">MWP</th>
                <th class="gwp-col">GWP</th>
                <th class="points-col">Pts</th>
              </tr>
            </thead>
            <tbody>
              {standings.map((standing: any) => {
                const mwp = standing.MatchWins / (standing.MatchWins + standing.MatchLosses + standing.MatchDraws) || 0;
                const gwp = standing.TeamGameWinPercentage || 0;
                const mwpPercent = (mwp * 100).toFixed(1);
                const gwpPercent = (gwp * 100).toFixed(1);

                const mwpClass = mwp > 0.59 ? 'wp-high' : mwp > 0.39 ? 'wp-medium' : 'wp-low';
                const gwpClass = gwp > 0.59 ? 'wp-high' : gwp > 0.39 ? 'wp-medium' : 'wp-low';

                const playerUrl = `/player/${standing.Team.Players[0].Username.toLowerCase()}`;

                return (
                  <tr class="clickable-row" onclick={`window.location.href='${playerUrl}'`}>
                    <td class="rank-col">
                      <div class="rank-number">{standing.Rank}</div>
                    </td>
                    <td class="player-col">
                      <div class="player-display-name">
                        {standing.Team.Players[0].DisplayName}
                      </div>
                    </td>
                    <td class="record-col">{standing.MatchRecord}</td>
                    <td class={`mwp-col ${mwpClass}`}>{mwpPercent}%</td>
                    <td class={`gwp-col ${gwpClass}`}>{gwpPercent}%</td>
                    <td class="points-col">{standing.Points}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {rounds.map((round) => {
        // Sort matches: regular matches first, byes last
        const sortedMatches = [...round.matches].sort((a: any, b: any) => {
          const aIsBye = a.Competitors.length === 1 || a.Competitors[0]?.ByeReason;
          const bIsBye = b.Competitors.length === 1 || b.Competitors[0]?.ByeReason;
          if (aIsBye && !bIsBye) return 1;
          if (!aIsBye && bIsBye) return -1;
          return 0;
        });

        return (
          <div class="round-card">
            <div class="round-header">Round {round.roundNumber}</div>
            <div class="round-table-container">
              <table class="round-table">
                <thead>
                  <tr>
                    <th class="round-player-col">Player 1</th>
                    <th class="round-player-col">Player 2</th>
                    <th class="round-result-col">Result</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedMatches.map((match: any) => {
                    const isBye = match.Competitors.length === 1 || match.Competitors[0]?.ByeReason;
                    const player1 = match.Competitors[0]?.Team?.Players[0];
                    const player2 = isBye ? null : match.Competitors[1]?.Team?.Players[0];

                    return (
                      <tr>
                        <td class="round-player-col">
                          <a href={`/player/${player1.Username.toLowerCase()}`} class="round-player-link">
                            {player1.DisplayName}
                          </a>
                        </td>
                        <td class="round-player-col">
                          {player2 ? (
                            <a href={`/player/${player2.Username.toLowerCase()}`} class="round-player-link">
                              {player2.DisplayName}
                            </a>
                          ) : (
                            <span class="bye-text">Bye</span>
                          )}
                        </td>
                        <td class="round-result-col">{match.ResultString}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        );
      })}
    </div>
  </div>
</PageLayout>

<style>
  .card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  .event-profile-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
  }

  .event-name-group h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: white;
  }

  .event-metadata {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .metadata-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 1.25rem;
    font-weight: 600;
    backdrop-filter: blur(10px);
    cursor: help;
    transition: all 0.2s ease;
  }

  .metadata-badge:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  .event-content {
    padding: 2rem;
  }

  .standings-section,
  .round-card {
    margin-bottom: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .round-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .round-table-container {
    background: white;
  }

  .round-table {
    width: 100%;
    border-collapse: collapse;
  }

  .round-table thead {
    background: #f9fafb;
  }

  .round-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.85rem;
    font-weight: 600;
    color: #764ba2;
  }

  .round-table tbody {
    background: white;
  }

  .round-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e0e0e0;
  }

  .round-table tbody tr:last-child td {
    border-bottom: none;
  }

  .round-table tbody tr:hover {
    background: #f9fafb;
  }

  .round-player-col {
    width: 35%;
  }

  .round-result-col {
    width: 30%;
    color: #374151;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .round-player-link {
    color: #1f2937;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
  }

  .round-player-link:hover {
    color: #764ba2;
  }

  .bye-text {
    color: #6b7280;
    font-style: italic;
    font-weight: 500;
  }

  .standings-table {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: #f9fafb;
  }

  th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.85rem;
    font-weight: 600;
    color: #764ba2;
  }

  tbody {
    background: white;
  }

  td {
    padding: 1.5rem;
    border-bottom: 1px solid #e0e0e0;
    text-align: left;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  tbody tr.clickable-row {
    cursor: pointer;
  }

  tbody tr.clickable-row:hover {
    background: #f8f9fa;
  }

  .rank-col {
    width: 80px;
    text-align: center;
  }

  .rank-number {
    font-weight: 700;
    font-size: 1.1rem;
    color: #333;
  }

  .player-col {
    min-width: 200px;
  }

  .player-display-name {
    color: #1f2937;
    font-weight: 600;
    font-size: 1rem;
  }

  .record-col {
    width: 120px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.95rem;
    color: #666;
  }

  .mwp-col,
  .gwp-col {
    width: 90px;
    text-align: center;
    font-weight: 700;
    font-size: 1rem;
  }

  .wp-high {
    color: #16a34a;
  }

  .wp-medium {
    color: #ea580c;
  }

  .wp-low {
    color: #dc2626;
  }

  .points-col {
    width: 80px;
    text-align: center;
    font-weight: 700;
    font-size: 1rem;
    color: #333;
  }

  @media (max-width: 640px) {
    .event-profile-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.5rem;
    }

    .event-name-group h1 {
      font-size: 1.5rem;
    }

    .event-metadata {
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .metadata-badge {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
    }

    .event-content {
      padding: 1.5rem;
    }

    th,
    td {
      padding: 0.75rem 0.5rem;
      font-size: 0.85rem;
    }

    .rank-col {
      width: 50px;
    }

    .player-col {
      min-width: 150px;
    }

    .round-header {
      padding: 1rem 1.5rem;
      font-size: 0.85rem;
    }

    .round-table th,
    .round-table td {
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
    }

    .round-result-col {
      font-size: 0.8rem;
    }
  }
</style>
