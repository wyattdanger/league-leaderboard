---
import PageLayout from '../../components/PageLayout.astro';
import LeagueHeader from '../../components/LeagueHeader.astro';
import LeagueNav from '../../components/LeagueNav.astro';
import Leaderboard from '../../components/Leaderboard.astro';
import EventList from '../../components/EventList.astro';
import {
  loadLeaguesConfig,
  loadLeagueStandings,
  aggregateOverallStandings,
} from '../../utils/data';
import { leagueNameToSlug } from '../../utils/helpers';
import { getTournamentMetadata } from '../../utils/tournamentData';
import type { League, LeagueStanding, TournamentMetadata } from '../../types';

export async function getStaticPaths() {
  const config = loadLeaguesConfig();
  const allLeagues = config.leagues;

  const paths = [];

  // Add paths for each league
  for (const league of allLeagues) {
    const slug = leagueNameToSlug(league.name);
    paths.push({
      params: { slug },
      props: { league, allLeagues, isOverall: false },
    });
  }

  // Add path for overall
  paths.push({
    params: { slug: 'overall' },
    props: { league: null, allLeagues, isOverall: true },
  });

  return paths;
}

const { league, allLeagues, isOverall } = Astro.props;

let standings: LeagueStanding[] | null = null;
let currentLeague: League | null = league;

if (isOverall) {
  standings = aggregateOverallStandings(allLeagues);
} else {
  standings = loadLeagueStandings(league.name);
}

// Load tournament metadata for event list
let tournamentMetadata: TournamentMetadata[] = [];
if (isOverall) {
  // For Overall, show all tournaments from all leagues
  const allTournamentIds = allLeagues.flatMap((l) => l.tournaments);
  tournamentMetadata = allTournamentIds
    .map((id) => getTournamentMetadata(id))
    .filter((meta): meta is TournamentMetadata => meta !== null);
} else if (currentLeague) {
  // For individual league, show only that league's tournaments
  tournamentMetadata = currentLeague.tournaments
    .map((id) => getTournamentMetadata(id))
    .filter((meta): meta is TournamentMetadata => meta !== null);
}
---

<PageLayout>
  <LeagueHeader />
  <LeagueNav currentLeague={currentLeague} allLeagues={allLeagues} isOverall={isOverall} />
  <Leaderboard standings={standings} />
  <EventList tournaments={tournamentMetadata} />
</PageLayout>
