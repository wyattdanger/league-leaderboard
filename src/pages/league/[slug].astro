---
import LeaguePage from '../../components/LeaguePage.astro';
import {
  loadLeaguesConfig,
  loadLeagueStandings,
  aggregateOverallStandings,
  isCurrentLeague,
} from '../../utils/data';
import { leagueNameToSlug } from '../../utils/helpers';
import { getTournamentMetadata } from '../../utils/tournamentData';
import type { League, LeagueStanding, TournamentMetadata } from '../../types';

export async function getStaticPaths() {
  const config = loadLeaguesConfig();
  const allLeagues = config.leagues;

  const paths = [];

  // Add paths for each league
  for (const league of allLeagues) {
    const slug = leagueNameToSlug(league.name);
    paths.push({
      params: { slug },
      props: { league, allLeagues, isOverall: false },
    });
  }

  // Add path for overall
  paths.push({
    params: { slug: 'overall' },
    props: { league: null, allLeagues, isOverall: true },
  });

  return paths;
}

const { league, allLeagues, isOverall } = Astro.props;

let standings: LeagueStanding[] | null = null;
let currentLeague: League | null = league;

if (isOverall) {
  standings = aggregateOverallStandings(allLeagues);
} else {
  standings = loadLeagueStandings(league.name);
}

// Load tournament metadata for event list
let tournamentMetadata: TournamentMetadata[] = [];
if (isOverall) {
  // For Overall, show all tournaments from all leagues
  const allTournamentIds = allLeagues.flatMap((l) => l.tournaments);
  tournamentMetadata = allTournamentIds
    .map((id) => getTournamentMetadata(id))
    .filter((meta): meta is TournamentMetadata => meta !== null);
} else if (currentLeague) {
  // For individual league, show only that league's tournaments
  tournamentMetadata = currentLeague.tournaments
    .map((id) => getTournamentMetadata(id))
    .filter((meta): meta is TournamentMetadata => meta !== null);
}

// Determine if this is the current league (league with most recent event)
const isCurrent = !isOverall && currentLeague ? isCurrentLeague(currentLeague, allLeagues) : false;

// Current league shows latest event, non-current leagues show their Top 8 if they have one
const showLatestEvent = isCurrent;
const top8Tournament =
  !isCurrent && currentLeague?.top8Tournament
    ? getTournamentMetadata(currentLeague.top8Tournament)
    : null;
---

<LeaguePage
  currentLeague={currentLeague}
  allLeagues={allLeagues}
  isOverall={isOverall}
  standings={standings}
  tournaments={tournamentMetadata}
  showLatestEvent={showLatestEvent}
  top8Tournament={top8Tournament}
/>
